# HTTP3：甩掉TCP、TLS包袱，构建高效网络

> **勘误说明**：本文原始标题中的"TCL"为笔误，正确应为"TLS"。由于文件夹名称无法修改，故仅在文章内容中进行了修正。

> **2025 更新说明**：本文最初撰写时 HTTP/3 尚处于草案阶段。截至 2025 年，IETF QUIC 协议（RFC 9000）和 HTTP/3（RFC 9114）均已正式标准化。所有主流浏览器（Chrome、Firefox、Safari、Edge）和主流服务器/CDN（Cloudflare、Akamai、Fastly、nginx、Apache 等）都已支持 HTTP/3。HTTP/3 不再是"未来的协议"，而是已经在大规模生产环境中运行的现实。

前面两篇文章我们分析了 HTTP / 1 和 HTTP / 2，在 HTTP / 2 出现之前，开发者需要采用很多变通的方式来解决 HTTP / 1 所存在的问题，不过 HTTP / 2 在 2018 年就开始得到了大规模的应用，HTTP / 1 中存在的一大堆缺陷都得到了解决。

HTTP / 2 的一个核心特性是使用了多路复用技术，因此它可以通过一个 TCP 连接来发送多个 URL 请求。多路复用技术能充分利用带宽，最大限度规避了 TCP 的慢启动所带来的问题，同时还实现了头部压缩、服务器推送等功能，使得页面资源的传输速度得到了大幅提升。在 HTTP / 1.1 时代，为了提升并行下载效率，浏览器为每个域名维护了 6 个 TCP 连接；而采用 HTTP / 2 之后，浏览器只需要为每个域名维护 1 个 TCP 持久连接，同时还解决了 HTTP / 1.1 队头阻塞的问题。

从目前的情况来看，HTTP / 2 似乎可以完美取代 HTTP / 1 了，不过 HTTP / 2 依然存在一些缺陷，于是就有了 HTTP / 3。和通常一样，介绍 HTTP / 3 之前，我们先来看看 HTTP / 2 到底有什么缺陷。

## TCP 的队头阻塞

虽然 HTTP / 2 解决了应用层面的队头阻塞问题，不过和 HTTP / 1.1 一样，HTTP / 2 依然是基于 TCP 协议的，而 TCP 最初就是为了单连接而设计的。你可以把 TCP 连接看成是两台计算机之前的一个虚拟管道，计算机的一端将要传输的数据按照顺序放入管道，最终数据会以相同的顺序出现在管道的另外一头。

接下来我们就来分析下，HTTP / 1.1 协议栈中 TCP 是如何传输数据的。为了直观理解，你可以参考下图：

![正常情况下的TCP传输数据过程](./img/tcp-transfer-data-process.png)

通过上图你会发现，从一端发送给另外一端的数据会被拆分为一个个按照顺序排列的数据包，这些数据包通过网络传输到了接收端，接收端再按照顺序将这些数据包组合成原始数据，这样就完成了数据传输。

不过，如果在数据传输的过程中，有一个数据因为网络故障或者其他原因而丢包了，那么整个 TCP 的连接就会处于暂停状态，需要等待丢失的数据包被重新传输过来。你可以把 TCP 连接看成是一个按照顺序传输数据的管道，管道中的任意一个数据丢失了，那之后的数据都需要等待该数据的重新传输。为了直观理解，你可以参考下图：

![TCP丢包状态](./img/tcp-packet-loss-status.png)

我们就把在 TCP 传输过程中，由于单个数据包的丢失而造成的阻塞称为 TCP 上的队头阻塞。

那队头阻塞是怎么影响 HTTP / 2 传输的呢？首先我们来看正常情况下 HTTP / 2 是怎么传输多路请求的，为了直观理解，你可以参考下图：

![HTTP/2多路复用](./img/http-2-multiplexing.png)

通过该图，我们知道在 HTTP / 2 中，多个请求是跑在一个 TCP 管道中的，如果任意一路数据流中出现了丢包的情况，那么就会阻塞该 TCP 连接中的所有请求。这不同于 HTTP / 1.1，使用 HTTP / 1.1 时，浏览器为每个域名开启了 6 个 TCP 连接，如果其中的 1 个 TCP 连接发生了队头阻塞，那么其他的 5 个连接依然可以继续传输数据。

所以随着丢包率的增加，HTTP / 2 的传输率也会越来越差。有测试数据表明，当系统达到了 2% 的丢包率时，HTTP / 1.1 的传输效率反而比 HTTP / 2 表现得更好。

## TCP 建立连接的延时

除了 TCP 队头阻塞之外，TCP 的握手过程也是影响传输效率的一个重要因素。

为了搞清楚 TCP 协议建立连接的延迟问题，我们还是先来回顾下网络延迟的概念，这会有助于你对后面内容的理解。网络延迟又称为 RTT（Round Trip Time）。我们把从浏览器发送一个数据包到服务器，再从服务器返回数据包到浏览器的整个往返时间称为 RTT（如下图）。RTT 是反映网络性能的一个重要指标。

![网络延时](./img/network-delayed.png)

那建立 TCP 连接时，需要花费多少个 RTT 呢？下面我们来计算下。

我们知道 HTTP / 1 和 HTTP / 2 都是使用 TCP 协议来传输的，而如果使用 HTTPS 的话，还需要使用 TLS 协议进行安全传输，而使用 TLS 也需要一个握手过程，这样就需要有两个握手延迟过程。

- 在建立 TCP 连接的时候，需要和服务器进行三次握手来确认连接成功，也就是说需要在消耗 1.5 个 RTT 之后才能进行数据传输。

- 进行 TLS 连接，TLS 有两个版本——TLS1.2 和 TLS1.3，每个版本建立连接所花的时间不同，大致是需要 1 ~ 2 个 RTT，关于 HTTPS 我们到后面的安全模块再做详细介绍。

总之，在传输数据之前，我们需要花掉 3 ~ 4 个 RTT。如果浏览器和服务器的物理距离较近，那么 1 个 RTT 的时间可能在 10 毫秒以内，也就是说总共要消耗掉 30 ~ 40 毫秒。这个时间也许用户还可以接受，但如果服务器相隔较远，那么 1 个 RTT 就可能需要 100 毫秒以上了，这种情况下整个握手过程需要 300 ~ 400 毫秒，这时用户就能明显地感受到"慢"了。

## TCP 协议僵化

现在我们知道了 TCP 协议存在队头阻塞和建立连接延迟等缺点，那我们是不是可以通过改进 TCP 协议来解决这些问题呢？

答案是：非常困难。之所以这样，主要有两个原因。

第一个是中间设备的僵化。要搞清楚什么是中间设备僵化，我们先要弄明白什么是中间设备。我们知道互联网是由多个网络互联的网状结构，为了能够保障互联网的正常工作，我们需要在互联网的各处搭建各种设备，这些设备就被称为中间设备。

这些中间设备有很多类型，并且每种设备都有自己的目的，这些还包括了路由器、防火墙、NAT、交换机等。它们通常依赖一些很少升级的软件，这些软件使用了大量的 TCP 特性，这些功能被设置之后就很少更新了。

所以，如果我们在客户端升级了 TCP 协议，但是当新协议的数据包经过这些中间设备时，它们可能不理解包的内容，于是这些数据就会被丢弃掉。这就是中间设备僵化，它是阻碍 TCP 更新的一大阻碍。

除了中间设备僵化外，操作系统也是导致 TCP 协议僵化的另外一个原因。因为 TCP 协议都是通过操作系统内核来实现的，应用程序只能使用不能修改。通常操作系统的更新都滞后于软件的更新，因此要想自由地更新内核中的 TCP 协议也是非常困难的。

## QUIC 协议

HTTP / 2 存在一些比较严重的与 TCP 协议相关的缺陷，但由于 TCP 协议僵化，我们几乎不可能通过修改 TCP 协议本身来解决这些问题，那么解决问题的思路是绕过 TCP 协议，发明一个 TCP 和 UDP 之外的新的传输协议。但是这也面临着和修改 TCP 一样的挑战，因为中间设备的僵化，这些设备只认 TCP 和 UDP，如果采用了新的协议，新协议在这些设备同样不被很友好地支持。

因此，HTTP / 3 选择了一个折衷的方法——UDP 协议，基于 UDP 实现了类似于 TCP 的多路数据流、传输可靠性等功能，我们把这套功能称为 QUIC 协议。关于 HTTP / 2 和 HTTP / 3 协议栈的比较，你可以参考下图：

![HTTP/2和HTTP/3协议栈](./img/http2-http3-agreement-stack.png)

通过上图我们可以看出，HTTP / 3 中的 QUIC 协议集合了以下几点功能。

- **实现了类似 TCP 的流量控制、传输可靠性的功能**。虽然 UDP 不提供可靠性的传输，但 QUIC 在 UDP 的基础之上增加了一层来保证数据可靠性传输。它提供了数据包重传、拥塞控制以及其他一些 TCP 中存在的特性。

- **集成了 TLS 加密功能**。目前 QUIC 使用的是 TLS1.3，相较于早期版本 TLS1.3 有更多的优点，其中最重要的一点是减少了握手所花费的 RTT 个数。

- **实现了 HTTP / 2 中的多路复用功能**。和 TCP 不同，QUIC 实现了在同一物理连接上可以有多个独立的逻辑数据流（如下图）。实现了数据流的单独传输，就解决了 TCP 中队头阻塞的问题。

![QUIC协议的多路复用](./img/quic-multiplexing.png)

- **实现了快速握手功能**。由于 QUIC 是基于 UDP 的，所以 QUIC 可以实现使用 0-RTT 或者 1-RTT 来建立连接，这意味着 QUIC 可以用最快的速度来发送和接收数据，这样可以大大提升首次打开页面的速度。

### QUIC 的 0-RTT 与 1-RTT 连接详解（2025 补充）

QUIC 的握手机制是其性能优势的核心之一，下面详细说明：

**1-RTT 首次连接**：当客户端首次连接到服务器时，QUIC 将传输层握手和 TLS 1.3 握手合并为一个步骤，只需要 **1 个 RTT** 即可完成连接建立并开始发送数据。相比之下，TCP + TLS 1.2 需要 3 个 RTT，TCP + TLS 1.3 也需要 2 个 RTT。

**0-RTT 重连**：当客户端再次连接到曾经访问过的服务器时，可以使用之前缓存的密钥信息在第一个数据包中就携带应用数据，实现 **0-RTT** 连接恢复。这意味着重连几乎没有额外的延迟开销。

> **0-RTT 的安全注意事项**：0-RTT 数据存在**重放攻击（Replay Attack）**的风险。攻击者可以捕获并重新发送客户端的 0-RTT 数据包，如果服务器无法区分原始请求和重放请求，就可能导致重复操作（例如重复转账）。因此：
> - 0-RTT 数据**不具备前向保密性**（Forward Secrecy）。
> - 服务器应确保 0-RTT 中承载的请求是**幂等的**（如 GET 请求），避免在 0-RTT 中发送可能产生副作用的请求（如 POST 请求）。
> - 服务器可以通过维护已使用的 0-RTT token 列表来检测和拒绝重放。

### QUIC 的连接迁移（2025 补充）

传统的 TCP 连接由四元组（源 IP、源端口、目标 IP、目标端口）标识。当用户从 Wi-Fi 切换到移动网络时，IP 地址会发生变化，TCP 连接就会中断，需要重新建立连接（包括 TCP 握手和 TLS 握手），这会导致明显的延迟和用户体验下降。

QUIC 使用一个**连接 ID（Connection ID）**来标识连接，而不是依赖 IP 地址和端口。这意味着：

- 当用户从 Wi-Fi 切换到 4G/5G 时，即使 IP 地址完全改变，QUIC 连接依然可以继续工作，无需重新握手。
- 在移动设备频繁切换网络的场景下（如乘坐地铁、进出电梯等），QUIC 的连接迁移能力可以显著提升用户体验。
- 这对于视频通话、实时通信等需要持续连接的应用尤为重要。

## HTTP / 3 的现状与部署（2025 更新）

截至 2025 年，HTTP/3 已经从实验性协议发展为成熟的生产级协议：

### 标准化进展

- **QUIC 协议**：2021 年 5 月发布为 RFC 9000（QUIC: A UDP-Based Multiplexed and Secure Transport）。
- **HTTP/3**：2022 年 6 月发布为 RFC 9114（HTTP/3）。
- **QPACK 头部压缩**：RFC 9204（QPACK: Field Compression for HTTP/3）。

### 浏览器支持

所有主流浏览器均已支持 HTTP/3：
- **Chrome**：自 Chrome 87（2020 年 11 月）起默认启用。
- **Firefox**：自 Firefox 88（2021 年 4 月）起默认启用。
- **Safari**：自 Safari 14（macOS Big Sur / iOS 14，2020 年）起开始支持，后续版本持续优化。
- **Edge**：基于 Chromium 内核，与 Chrome 保持同步支持。

### 服务器和 CDN 支持

- **CDN**：Cloudflare、Akamai、Fastly、Google Cloud CDN、Amazon CloudFront 等主流 CDN 均已支持 HTTP/3。
- **Web 服务器**：nginx（通过 quiche 或 ngtcp2 模块）、LiteSpeed、Caddy 等已原生支持；Apache 也通过模块提供了支持。
- **编程语言/框架**：Go、Rust、Python、Node.js 等语言的 HTTP 库也陆续提供了 QUIC/HTTP/3 支持。

### 仍存在的挑战

虽然 HTTP/3 已得到广泛支持，但部署中仍有一些需要注意的问题：

- **UDP 优化**：部分网络设备和操作系统对 UDP 的处理效率仍低于 TCP，内核级别的 UDP 优化（如 GSO/GRO、io_uring 等）正在持续改进。
- **防火墙和企业网络**：某些企业防火墙和网络环境可能会限制或阻断 UDP 流量，需要确保回退到 HTTP/2（基于 TCP）的机制正常工作。
- **调试工具**：相比成熟的 TCP 抓包和分析工具，QUIC 的调试生态系统仍在完善中（不过 Wireshark 等工具已增加了 QUIC 支持）。

## 总结

好了，今天就介绍到这里，下面我来总结下本文的主要内容。

我们首先分析了 HTTP / 2 中所存在的一些问题，主要包括了 TCP 的队头阻塞、建立 TCP 连接的延时、TCP 协议僵化等问题。

这些问题都是 TCP 的内部问题，因此要解决这些问题就要优化 TCP 或者"另起炉灶"创造新的协议。由于优化 TCP 协议存在着诸多挑战，所以官方选择了创建新的 QUIC 协议。

HTTP / 3 正是基于 QUIC 协议的，你可以把 QUIC 看成是集成了"TCP + HTTP / 2 的多路复用 + TLS 等功能"的一套协议。这是集众家所长的一个协议，从协议最底层对 Web 的文件传输做了比较彻底的优化。

> **2025 关键总结**：
> - QUIC（RFC 9000）和 HTTP/3（RFC 9114）均已正式标准化，不再是实验性协议。
> - 所有主流浏览器和主要 CDN/服务器均已支持 HTTP/3。
> - QUIC 的核心优势包括：消除 TCP 队头阻塞、快速握手（1-RTT / 0-RTT）、内置 TLS 1.3 加密、连接迁移。
> - 0-RTT 重连虽然性能优异，但需注意重放攻击的安全风险。
> - 连接迁移特性使得 QUIC 在移动网络场景下表现尤为出色。
> - HTTP/3 的采用率正在快速增长，已有约 30% 的网站支持 HTTP/3，预计将持续增长。
